---
phase: 10-magellan-v2-integration-and-bugfixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/analysis/mod.rs
  - src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Magellan v2.0.0 compiles as dependency"
    - "analysis module exists with MagellanBridge struct"
    - "CodeGraph::open() works from Mirage code"
  artifacts:
    - path: "Cargo.toml"
      contains: "magellan = { path = \"../magellan\" }"
    - path: "src/analysis/mod.rs"
      provides: "MagellanBridge wrapper for inter-procedural analysis"
      exports: ["MagellanBridge", "open_magellan_db"]
    - path: "src/lib.rs"
      exports: ["analysis"]
  key_links:
    - from: "src/analysis/mod.rs"
      to: "magellan::CodeGraph"
      via: "pub use magellan::CodeGraph"
      pattern: "use magellan::CodeGraph"
---

<objective>
Add Magellan v2.0.0 as a local path dependency and create the analysis module with a MagellanBridge wrapper for inter-procedural graph algorithms.

Purpose: Enable Mirage to use Magellan's call graph algorithms (reachable_symbols, dead_symbols, detect_cycles) combined with Mirage's intra-procedural CFG analysis.

Output: Working dependency on Magellan library + new analysis module with bridge struct.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-magellan-v2-integration-and-bugfixes/10-RESEARCH.md

# Dependency path for local development
magellan_path = "../magellan"
</context>

<tasks>

<task type="auto">
  <name>Add Magellan v2.0.0 dependency</name>
  <files>Cargo.toml</files>
  <action>
  1. Add magellan as a local path dependency in [dependencies]:
     ```
     magellan = { path = "../magellan" }
     ```
  2. Also add sqlitegraph explicitly (version from Magellan):
     ```
     sqlitegraph = "1.3"
     ```
  3. Run `cargo check` to verify dependency resolves and compiles
  4. If ../magellan path doesn't exist in some environments, also provide git fallback as comment

  IMPORTANT: Magellan is NOT on crates.io - must use path or git dependency.
  </action>
  <verify>cargo check passes without errors</verify>
  <done>magellan dependency added, cargo check succeeds</done>
</task>

<task type="auto">
  <name>Create analysis module with MagellanBridge</name>
  <files>src/analysis/mod.rs</files>
  <action>
  Create new src/analysis/mod.rs with:

  1. Module structure:
     - pub use magellan::CodeGraph (re-export for convenience)
     - pub struct MagellanBridge wrapper
     - impl MagellanBridge with open() method
     - Helper methods for common queries

  2. MagellanBridge API:
     ```rust
     pub struct MagellanBridge {
         graph: CodeGraph,
     }

     impl MagellanBridge {
         pub fn open(db_path: &str) -> Result<Self> {
             let graph = CodeGraph::open(db_path)?;
             Ok(Self { graph })
         }

         pub fn graph(&self) -> &CodeGraph {
             &self.graph
         }

         // Convenience wrapper for reachability
         pub fn reachable_symbols(&self, symbol_id: &str) -> Result<Vec<SymbolInfo>> {
             self.graph.reachable_symbols(symbol_id, None)
         }

         // More wrappers added in later plans
     }
     ```

  3. Use anyhow::Result for error handling
  4. Document that db_path should match Mirage's database path

  Reference: /home/feanor/Projects/magellan/src/graph/algorithms.rs for API patterns
  </action>
  <verify>cargo check passes, src/analysis/mod.rs compiles</verify>
  <done>analysis module created with MagellanBridge struct</done>
</task>

<task type="auto">
  <name>Export analysis module from lib.rs</name>
  <files>src/lib.rs</files>
  <action>
  1. Add `pub mod analysis;` to src/lib.rs
  2. Add a module documentation comment:
     ```rust
     //! Inter-procedural analysis using Magellan's call graph
     //!
     //! This module provides a bridge to Magellan's graph algorithms,
     //! enabling combined inter-procedural (Magellan) and intra-procedural (Mirage) analysis.
     pub mod analysis;
     ```
  3. Verify re-exports: analysis module should re-export key types from Magellan
  </action>
  <verify>cargo check passes, `use mirage::analysis::MagellanBridge` works</verify>
  <done>analysis module exported from lib.rs</done>
</task>

</tasks>

<verification>
1. cargo check passes completely
2. cargo test compiles (tests can run in later plans)
3. MagellanBridge can be imported and instantiated in code
</verification>

<success_criteria>
1. Magellan v2.0.0 compiles as dependency
2. src/analysis/mod.rs exists with MagellanBridge struct
3. MagellanBridge::open() can create a bridge instance
4. CodeGraph is re-exported from analysis module
5. All existing tests still pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/10-magellan-v2-integration-and-bugfixes/10-01-SUMMARY.md`
</output>
