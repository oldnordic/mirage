---
phase: 06-cli-interface
plan: 04
type: execute
wave: 2
depends_on: [06-02]
files_modified: [src/cli/mod.rs]
autonomous: true

must_haves:
  truths:
    - "mirage unreachable finds unreachable code blocks"
    - "mirage unreachable shows branch details when --show-branches is set"
  artifacts:
    - path: "src/cli/mod.rs"
      provides: "Implemented unreachable() command handler"
      min_lines: 50
  key_links:
    - from: "src/cli/mod.rs::unreachable()"
      to: "src/cfg/reachability.rs::find_unreachable"
      via: "direct function call"
      pattern: "find_unreachable|unreachable_block_ids"
---

<objective>
Implement the `mirage unreachable` command to find unreachable code blocks within functions. This connects the CLI stub to the reachability analysis backend from Phase 3.

**Purpose:** Enable users to detect dead code that cannot be reached from the entry block.

**Output:** Working `mirage unreachable` command with human/JSON/pretty output formats.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-interface/06-RESEARCH.md
@src/cli/mod.rs
@src/cfg/reachability.rs
@.planning/phases/06-cli-interface/06-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Implement unreachable() command with dead code detection</name>
  <files>src/cli/mod.rs</files>
  <action>
  In `src/cli/mod.rs`, replace the stub `unreachable()` function:

  1. Update signature from `unreachable(_args: UnreachableArgs)` to `unreachable(args: UnreachableArgs, cli: &Cli)`

  2. Add database connection using `MirageDb::open()` with `resolve_db_path(cli.db.clone())`

  3. Load/create CFG using `create_test_cfg()` (same pattern as 06-02)

  4. Find unreachable blocks using `find_unreachable(&cfg)` or `unreachable_block_ids(&cfg)`

  5. Format output based on cli.output and args:
     - Human: Print list of unreachable blocks with their IDs and statements
     - If args.show_branches: include edge information leading to unreachable code
     - Json/Pretty: Wrap in JsonResponse with UnreachableBlocksSummary

  6. Handle the case where no unreachable blocks exist (display "No unreachable code found" message)

  **Key imports to add:**
  - `use crate::cfg::reachability::{find_unreachable, unreachable_block_ids};`
  - `use crate::storage::MirageDb;`

  **Response struct for JSON output:**
  ```rust
  #[derive(serde::Serialize)]
  struct UnreachableResponse {
      function: String,
      unreachable_count: usize,
      blocks: Vec<UnreachableBlock>,
  }

  #[derive(serde::Serialize)]
  struct UnreachableBlock {
      block_id: usize,
      kind: String,
      statements: Vec<String>,
      terminator: String,
  }
  ```
  </action>
  <verify>
  Run `cargo build` to verify compilation.
  </verify>
  <done>
  The unreachable() command successfully:
  - Finds and displays unreachable code blocks
  - Shows branch details when --show-branches flag is set
  - Outputs in human/json/pretty formats
  - Reports "no unreachable code" when all blocks are reachable
  </done>
</task>

<task type="auto">
  <name>Add tests for unreachable command</name>
  <files>src/cli/mod.rs</files>
  <action>
  In the `#[cfg(test)] mod tests` section, add:

  1. Test for detecting unreachable blocks (creates CFG with disconnected node)
  2. Test for show_branches flag behavior
  3. Test for fully reachable CFG (returns empty list)
  4. Test for JSON output format verification

  Use the existing `create_test_cfg()` helper and create a helper that adds an unreachable block.
  </action>
  <verify>
  Run `cargo test` to verify all tests pass.
  </verify>
  <done>
  Tests cover the unreachable() command behavior for all scenarios.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- [ ] `cargo build` succeeds with no warnings
- [ ] `cargo test` passes all tests
- [ ] unreachable() command finds unreachable blocks
- [ ] --show-branches flag includes edge information
- [ ] All three output formats work correctly
- [ ] Empty result is handled gracefully
</verification>

<success_criteria>
1. `mirage unreachable --function test_func` lists unreachable blocks
2. `mirage unreachable --function test_func --show-branches` includes branch details
3. `mirage unreachable --function test_func --output json` outputs valid JSON
4. Fully reachable functions show "No unreachable code found"
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-interface/06-04-SUMMARY.md`
</output>
