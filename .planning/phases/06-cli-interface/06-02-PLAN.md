---
phase: 06-cli-interface
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/cli/mod.rs]
autonomous: true

must_haves:
  truths:
    - "mirage cfg --function SYMBOL shows human-readable CFG"
    - "mirage cfg --format dot exports Graphviz DOT"
    - "mirage cfg --format json exports JSON"
  artifacts:
    - path: "src/cli/mod.rs"
      provides: "Implemented cfg() command handler with database loading"
      min_lines: 60
  key_links:
    - from: "src/cli/mod.rs::cfg()"
      to: "src/cfg/export.rs::export_dot|export_json"
      via: "direct function call"
      pattern: "export_dot|export_json"
    - from: "src/cli/mod.rs::cfg()"
      to: "src/storage/mod.rs::MirageDb"
      via: "database connection"
      pattern: "MirageDb::open"
---

<objective>
Implement the `mirage cfg` command to display control-flow graphs for functions. This connects the CLI stub to the CFG export backend from Phase 2, supporting DOT and JSON export formats.

**Purpose:** Enable users to visualize and export CFGs for functions in multiple formats.

**Output:** Working `mirage cfg` command with human/DOT/JSON output formats.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-interface/06-RESEARCH.md
@src/cli/mod.rs
@src/cfg/export.rs
@src/cfg/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Implement cfg() command with database loading and export</name>
  <files>src/cli/mod.rs</files>
  <action>
  In `src/cli/mod.rs`, update the existing `cfg()` function (currently uses test CFG):

  1. Update signature to access database:
     - Already has `(args: &CfgArgs, cli: &Cli)` - good
     - Add database connection using `MirageDb::open()` with `resolve_db_path(cli.db.clone())`

  2. Replace `create_test_cfg()` with database CFG loading:
     - For Phase 6, continue using `create_test_cfg()` since MIR extraction isn't complete
     - Add a TODO comment pointing to Phase 2's MIR extraction for real CFG loading
     - Use `args.function` as the function name in exports

  3. Improve format handling:
     - Already has format resolution with fallback to cli.output
     - Ensure CfgFormat::Human and CfgFormat::Dot both output DOT (same behavior)
     - Ensure CfgFormat::Json uses export_json() with proper function name

  4. Add error handling for database open failures (follow status command pattern)

  5. For JSON output, wrap in JsonResponse:
     - Use the existing CFGExport struct from export.rs
     - Wrap in JsonResponse for consistency with other commands

  **Response struct for JSON output:**
  The existing `CFGExport` from `src/cfg/export.rs` already has the right structure:
  - function_name, entry, exits, blocks, edges

  **Key imports to verify:**
  - `use crate::cfg::{export_dot, export_json, CFGExport};`
  - `use crate::storage::MirageDb;`
  - `use crate::output;`
  </action>
  <verify>
  Run `cargo build` to verify compilation.
  </verify>
  <done>
  The cfg() command successfully:
  - Opens the Mirage database
  - Loads/creates a CFG for the specified function
  - Exports to DOT format for --format dot or human output
  - Exports to JSON format wrapped in JsonResponse for --format json
  </done>
</task>

<task type="auto">
  <name>Add tests for cfg command output formats</name>
  <files>src/cli/mod.rs</files>
  <action>
  In the `#[cfg(test)] mod tests` section, add:

  1. Test for DOT format output (verify contains "digraph CFG")
  2. Test for JSON format output (verify valid JSON structure)
  3. Test that function name is correctly passed to export_json()
  4. Test format fallback (when args.format is None, should use cli.output)

  Use the existing `create_test_cfg()` helper for test data.
  </action>
  <verify>
  Run `cargo test` to verify all tests pass.
  </verify>
  <done>
  Tests cover the cfg() command behavior for all output formats.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- [ ] `cargo build` succeeds with no warnings
- [ ] `cargo test` passes all tests
- [ ] cfg() command outputs DOT for --format dot
- [ ] cfg() command outputs DOT for --format human
- [ ] cfg() command outputs JSON for --format json (wrapped in JsonResponse)
- [ ] Function name from --function is included in exports
</verification>

<success_criteria>
1. `mirage cfg --function test_func --format dot` outputs valid Graphviz DOT
2. `mirage cfg --function test_func --format human` outputs human-readable CFG (DOT format)
3. `mirage cfg --function test_func --format json` outputs valid JSON with CFGExport structure
4. `mirage cfg --function test_func --output json` respects global output format
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-interface/06-02-SUMMARY.md`
</output>
