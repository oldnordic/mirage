---
phase: 06-cli-interface
plan: 05
type: execute
wave: 3
depends_on: [06-01]
files_modified: [src/cli/mod.rs]
autonomous: true

must_haves:
  truths:
    - "mirage verify --path-id ID verifies path still valid"
    - "Verification checks if path exists in current enumeration"
  artifacts:
    - path: "src/cli/mod.rs"
      provides: "Implemented verify() command handler"
      min_lines: 60
  key_links:
    - from: "src/cli/mod.rs::verify()"
      to: "src/cfg/paths.rs::enumerate_paths_cached"
      via: "direct function call"
      pattern: "enumerate_paths_cached|get_or_enumerate_paths"
    - from: "src/cli/mod.rs::verify()"
      to: "src/storage/paths.rs::get_cached_paths"
      via: "database query for path lookup"
      pattern: "get_cached_paths"
---

<objective>
Implement the `mirage verify` command to verify that a cached path is still valid after code changes. This connects the CLI stub to the path caching backend from Phase 5.

**Purpose:** Enable users to verify if a previously enumerated path still exists in the current code state.

**Output:** Working `mirage verify` command with human/JSON/pretty output formats.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-interface/06-RESEARCH.md
@src/cli/mod.rs
@src/cfg/paths.rs
@src/storage/paths.rs
@.planning/phases/06-cli-interface/06-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Implement verify() command for path validation</name>
  <files>src/cli/mod.rs</files>
  <action>
  In `src/cli/mod.rs`, replace the stub `verify()` function:

  1. Update signature from `verify(_args: VerifyArgs)` to `verify(args: VerifyArgs, cli: &Cli)`

  2. Add database connection using `MirageDb::open()` with `resolve_db_path(cli.db.clone())`

  3. Look up the path in the cache:
     - Query cfg_paths table for the given path_id
     - If not found in cache, return "Path not found in cache" result

  4. If path is cached, verify it still exists:
     - Load/create CFG using `create_test_cfg()`
     - Re-enumerate paths using `enumerate_paths_cached()`
     - Check if any enumerated path has the same path_id
     - Note: For Phase 6, this is a simple existence check since we're using test CFG

  5. Format output based on cli.output:
     - Human: Print "Path ID <id>: valid" or "Path ID <id>: invalid (not found in current enumeration)"
     - Json/Pretty: Wrap in JsonResponse with VerifyResult

  6. Handle edge cases:
     - Invalid path_id format
     - Path exists in cache but function not found
     - Cache miss vs. invalid path

  **Key imports to add:**
  - `use crate::cfg::{Path, enumerate_paths_cached};`
  - `use crate::storage::{MirageDb, get_cached_paths};`
  - `use crate::output;`

  **Response struct for JSON output:**
  ```rust
  #[derive(serde::Serialize)]
  struct VerifyResult {
      path_id: String,
      valid: bool,
      found_in_cache: bool,
      function_id: Option<i64>,
      reason: String,
  }
  ```
  </action>
  <verify>
  Run `cargo build` to verify compilation.
  </verify>
  <done>
  The verify() command successfully:
  - Looks up path_id in cache
  - Re-enumerates function to check if path still exists
  - Reports validity with clear reason
  - Outputs in human/json/pretty formats
  </done>
</task>

<task type="auto">
  <name>Add tests for verify command</name>
  <files>src/cli/mod.rs</files>
  <action>
  In the `#[cfg(test)] mod tests` section, add:

  1. Test for valid path verification (path exists in both cache and current enumeration)
  2. Test for invalid path (exists in cache but not in current enumeration)
  3. Test for cache miss (path_id not found in database)
  4. Test for invalid path_id format
  5. Test JSON output format verification

  Use the existing `create_test_cfg()` helper and create a mock cached path.
  </action>
  <verify>
  Run `cargo test` to verify all tests pass.
  </verify>
  <done>
  Tests cover the verify() command behavior for all scenarios.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- [ ] `cargo build` succeeds with no warnings
- [ ] `cargo test` passes all tests
- [ ] verify() command checks path validity against current enumeration
- [ ] Cache miss is handled gracefully
- [ ] All three output formats work correctly
- [ ] Clear reason messages for invalid paths
</verification>

<success_criteria>
1. `mirage verify --path-id abc123` reports validity status
2. Valid paths show "valid: true" with found_in_cache: true
3. Invalid paths show "valid: false" with reason
4. Missing paths show "found_in_cache: false"
5. `mirage verify --path-id abc123 --output json` outputs valid JSON
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-interface/06-05-SUMMARY.md`
</output>
