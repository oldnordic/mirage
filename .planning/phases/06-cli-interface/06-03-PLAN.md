---
phase: 06-cli-interface
plan: 03
type: execute
wave: 2
depends_on: [06-02]
files_modified: [src/cli/mod.rs]
autonomous: true

must_haves:
  truths:
    - "mirage dominators --function SYMBOL shows dominance tree"
    - "mirage dominators --must-pass-through BLOCK proves mandatory execution"
  artifacts:
    - path: "src/cli/mod.rs"
      provides: "Implemented dominators() command handler"
      min_lines: 70
  key_links:
    - from: "src/cli/mod.rs::dominators()"
      to: "src/cfg/dominators.rs::DominatorTree"
      via: "direct function call"
      pattern: "DominatorTree::new|compute_dominator_tree"
    - from: "src/cli/mod.rs::dominators()"
      to: "src/cfg/post_dominators.rs::PostDominatorTree"
      via: "direct function call for --post flag"
      pattern: "PostDominatorTree::new"
---

<objective>
Implement the `mirage dominators` command to display dominance relationships for functions. This connects the CLI stub to the dominance analysis backend from Phase 4, supporting dominance tree display and must-pass-through queries.

**Purpose:** Enable users to query dominance relationships and prove which blocks must execute on any path from entry to exit.

**Output:** Working `mirage dominators` command with human/JSON/pretty output formats.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-interface/06-RESEARCH.md
@src/cli/mod.rs
@src/cfg/dominators.rs
@src/cfg/post_dominators.rs
@.planning/phases/06-cli-interface/06-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Implement dominators() command with dominance tree display</name>
  <files>src/cli/mod.rs</files>
  <action>
  In `src/cli/mod.rs`, replace the stub `dominators()` function:

  1. Update signature from `dominators(_args: DominatorsArgs)` to `dominators(args: DominatorsArgs, cli: &Cli)`

  2. Add database connection using `MirageDb::open()` with `resolve_db_path(cli.db.clone())`

  3. Load/create CFG using `create_test_cfg()` (same pattern as 06-02)

  4. Compute dominator tree based on args.post flag:
     - If args.post is false: `DominatorTree::new(&cfg)?`
     - If args.post is true: `PostDominatorTree::new(&cfg)?`

  5. Handle the `must_pass_through` query if specified:
     - Parse the block ID from args.must_pass_through
     - Find all nodes that must pass through this block
     - Use `dominates()` or `post_dominates()` to check each node
     - Display results showing which nodes are dominated by the specified block

  6. Format output based on cli.output:
     - Human: Print dominance tree as indented hierarchy or list of dominators
     - Json/Pretty: Wrap in JsonResponse with DominanceTreeSummary

  7. Handle errors gracefully (no dominator tree if CFG is empty)

  **Key imports to add:**
  - `use crate::cfg::{DominatorTree, PostDominatorTree, BlockId};`
  - `use crate::storage::MirageDb;`

  **Response struct for JSON output:**
  ```rust
  #[derive(serde::Serialize)]
  struct DominanceResponse {
      function: String,
      kind: String,  // "dominators" or "post-dominators"
      root: Option<usize>,
      dominance_tree: Vec<DominatorEntry>,
      must_pass_through: Option<MustPassThroughResult>,
  }

  #[derive(serde::Serialize)]
  struct DominatorEntry {
      block: usize,
      immediate_dominator: Option<usize>,
      dominates: Vec<usize>,
  }

  #[derive(serde::Serialize)]
  struct MustPassThroughResult {
      block: usize,
      must_pass: Vec<usize>,
  }
  ```
  </action>
  <verify>
  Run `cargo build` to verify compilation.
  </verify>
  <done>
  The dominators() command successfully:
  - Computes and displays dominance tree for a function
  - Computes post-dominators when --post flag is set
  - Shows which blocks must pass through a given block with --must-pass-through
  - Outputs in human/json/pretty formats
  </done>
</task>

<task type="auto">
  <name>Add tests for dominators command</name>
  <files>src/cli/mod.rs</files>
  <action>
  In the `#[cfg(test)] mod tests` section, add:

  1. Test for dominator tree computation (verify root and children)
  2. Test for post-dominator flag behavior
  3. Test for must_pass_through query (verifies dominated nodes are correctly identified)
  4. Test for empty CFG handling (graceful error)

  Use the existing `create_test_cfg()` helper for test data.
  </action>
  <verify>
  Run `cargo test` to verify all tests pass.
  </verify>
  <done>
  Tests cover the dominators() command behavior including post-dominators and must-pass-through queries.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- [ ] `cargo build` succeeds with no warnings
- [ ] `cargo test` passes all tests
- [ ] dominators() command computes dominance tree
- [ ] --post flag switches to post-dominator computation
- [ ] --must-pass-through BLOCK shows nodes dominated by BLOCK
- [ ] All three output formats work correctly
</verification>

<success_criteria>
1. `mirage dominators --function test_func` shows dominance tree
2. `mirage dominators --function test_func --post` shows post-dominator tree
3. `mirage dominators --function test_func --must-pass-through 2` lists all blocks that must execute through block 2
4. `mirage dominators --function test_func --output json` outputs valid JSON
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-interface/06-03-SUMMARY.md`
</output>
