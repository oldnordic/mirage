---
phase: 10-magellan-v2-integration-and-bugfixes
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/analysis/mod.rs
  - src/cli/mod.rs
  - src/cfg/paths.rs
autonomous: true

must_haves:
  truths:
    - "blast-zone command uses call graph for inter-procedural impact"
    - "MagellanBridge has reachable_symbols() wrapper"
    - "Blast zone shows forward and backward call graph reachability"
  artifacts:
    - path: "src/analysis/mod.rs"
      provides: "EnhancedBlastZone combining call graph + CFG paths"
      exports: ["EnhancedBlastZone", "BlastZoneResult"]
    - path: "src/cli/mod.rs"
      contains: "blast-zone command with --use-call-graph flag"
  key_links:
    - from: "src/cli/mod.rs"
      to: "src/analysis/mod.rs"
      via: "MagellanBridge::reachable_symbols()"
      pattern: "reachable_symbols"
    - from: "src/cli/mod.rs"
      to: "src/cfg/paths.rs"
      via: "compute_path_impact()"
      pattern: "compute_path_impact"
---

<objective>
Enhance the blast-zone command to use Magellan's call graph reachability for inter-procedural impact analysis, combined with Mirage's path-based impact.

Purpose: More accurate impact analysis - show which FUNCTIONS are affected by changes (call graph) and which PATHS/BLOCKS are affected within functions (CFG).

Output: blast-zone command with --use-call-graph flag shows combined impact scope.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-magellan-v2-integration-and-bugfixes/10-RESEARCH.md
@.planning/phases/10-magellan-v2-integration-and-bugfixes/10-01-SUMMARY.md

# Existing blast-zone command
src/cli/mod.rs has BlastZoneArgs with function, block_id, path_id, max_depth
src/cfg/paths.rs has compute_path_impact() for CFG-level impact
</context>

<tasks>

<task type="auto">
  <name>Add call graph reachability wrappers to MagellanBridge</name>
  <files>src/analysis/mod.rs</files>
  <action>
  Add to src/analysis/mod.rs:

  1. Add EnhancedBlastZone response struct:
     ```rust
     #[derive(Debug, Clone, serde::Serialize)]
     pub struct EnhancedBlastZone {
         /// Target function/block being analyzed
         pub target: String,
         /// Forward: What functions this affects (via call graph)
         pub forward_reachable: Vec<SymbolInfo>,
         /// Backward: What functions affect this (reverse call graph)
         pub backward_reachable: Vec<SymbolInfo>,
         /// Intra-procedural: Path-based impact within function
         pub path_impact: Option<PathImpactSummary>,
     }

     #[derive(Debug, Clone, serde::Serialize)]
     pub struct PathImpactSummary {
         pub path_id: Option<String>,
         pub path_length: usize,
         pub blocks_affected: Vec<usize>,
         pub unique_blocks_count: usize,
     }
     ```

  2. Add reachability methods to MagellanBridge:
     ```rust
     impl MagellanBridge {
         /// Get symbols reachable from starting symbol (forward call graph)
         pub fn reachable_symbols(&self, symbol_id: &str) -> Result<Vec<SymbolInfo>> {
             self.graph.reachable_symbols(symbol_id, None)
                 .map(|r| r.symbols)
         }

         /// Get symbols that can reach this symbol (reverse call graph)
         pub fn reverse_reachable_symbols(&self, symbol_id: &str) -> Result<Vec<SymbolInfo>> {
             // Call graph reverse reachability
             // Magellan's reverse_reachable_symbols returns callers
             self.graph.reverse_reachable_symbols(symbol_id, None)
                 .map(|r| r.symbols)
         }
     }
     ```

  3. Import SymbolInfo from magellan
  </action>
  <verify>cargo check passes, reachability methods compile</verify>
  <done>MagellanBridge has forward/backward reachability methods</done>
</task>

<task type="auto">
  <name>Add --use-call-graph flag to blast-zone CLI</name>
  <files>src/cli/mod.rs</files>
  <action>
  1. Update BlastZoneArgs struct:
     ```rust
     #[derive(Parser, Debug, Clone)]
     pub struct BlastZoneArgs {
         /// Function symbol ID or name (for block-based analysis)
         #[arg(long)]
         pub function: Option<String>,

         /// Block ID to analyze impact from (default: entry block 0)
         #[arg(long)]
         pub block_id: Option<usize>,

         /// Path ID to analyze impact for
         #[arg(long)]
         pub path_id: Option<String>,

         /// Maximum depth to traverse
         #[arg(long, default_value_t = 100)]
         pub max_depth: usize,

         /// Include error paths in analysis
         #[arg(long)]
         pub include_errors: bool,

         /// Use call graph for inter-procedural impact analysis
         #[arg(long)]
         pub use_call_graph: bool,
     }
     ```

  2. In blast_zone command handler, when --use-call-graph is true:
     - Resolve function name to symbol_id
     - Open MagellanBridge
     - Get forward_reachable (what this function affects)
     - Get backward_reachable (what affects this function)
     - Combine with existing path/block impact if path_id or block_id provided

  3. Update BlastZoneResponse to include call graph data:
     ```rust
     #[derive(serde::Serialize)]
     struct BlastZoneResponse {
         // ... existing fields ...
         forward_impact: Option<Vec<SymbolInfo>>,
         backward_impact: Option<Vec<SymbolInfo>>,
     }
     ```

  4. For human output, show:
     - "Forward Impact (N functions):" list
     - "Backward Impact (M functions):" list
     - "Intra-procedural Impact:" existing output
  </action>
  <verify>cargo check passes, blast-zone command compiles</verify>
  <done>--use-call-graph flag added to blast-zone command</done>
</task>

<task type="auto">
  <name>Test enhanced blast zone with call graph</name>
  <files>src/analysis/mod.rs</files>
  <action>
  1. Add unit test for MagellanBridge reachability:
     - Use test database with call graph
     - Create symbols: main -> func_a -> func_b
     - Test reachable_symbols("main") returns [func_a, func_b]
     - Test reverse_reachable_symbols("func_b") returns [func_a, main]

  2. Integration test for blast-zone command:
     - Create test call graph with mutual calls
     - Run blast-zone with --use-call-graph
     - Verify forward and backward impact lists are correct

  3. Add doctest examples for reachability methods
  </action>
  <verify>cargo test passes for blast zone tests</verify>
  <done>Enhanced blast zone tested with call graph</done>
</task>

</tasks>

<verification>
1. `mirage blast-zone --function foo --use-call-graph` shows call graph impact
2. Forward and backward reachability both work
3. JSON output includes forward_impact and backward_impact arrays
4. Human output separates inter and intra procedural impact
5. All tests pass
</verification>

<success_criteria>
1. --use-call-graph flag works on blast-zone command
2. Both forward and backward reachability computed
3. Combined with existing path-based impact
4. Output format clearly separates call graph from CFG impact
</success_criteria>

<output>
After completion, create `.planning/phases/10-magellan-v2-integration-and-bugfixes/10-03-SUMMARY.md`
</output>
