---
phase: 09-mir-integration-database-loading
plan: 04
type: execute
wave: 3
depends_on: [09-01, 09-03]
files_modified:
  - src/cli/mod.rs
  - src/cfg/mod.rs
  - src/storage/mod.rs
autonomous: true

must_haves:
  truths:
    - "mirage blast-zone --function SYMBOL --block-id N shows reachable blocks/functions"
    - "mirage blast-zone --path-id ID shows impact scope for execution path"
    - "Blast zone analysis uses stored CFG data and path enumeration"
    - "Results include block IDs, function names, and impact depth"
  artifacts:
    - path: "src/cli/mod.rs"
      provides: "blast_zone() command implementation"
      exports: ["blast_zone()"]
      min_lines: 80
    - path: "src/cfg/mod.rs"
      provides: "Blast zone analysis functions"
      exports: ["compute_block_impact", "compute_path_impact"]
      min_lines: 60
    - path: "src/storage/mod.rs"
      provides: "Impact analysis utilities"
      exports: ["get_function_for_block", "get_calls_from_block"]
  key_links:
    - from: "blast_zone()"
      to: "compute_block_impact(), compute_path_impact()"
      via: "performs reachability analysis for impact"
      pattern: "compute.*impact"
    - from: "compute_block_impact()"
      to: "can_reach(), find_reachable()"
      via: "uses reachability analysis from Phase 3"
      pattern: "can_reach|find_reachable"
---

<objective>
Implement `mirage blast-zone` command for path-based impact analysis.

Purpose: Enable users to understand the impact scope of code changes by analyzing what code is reachable from a given block or path.

Output: Working blast-zone command that shows impact analysis for blocks and paths.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mir-integration-database-loading/09-01-SUMMARY.md
@.planning/phases/09-mir-integration-database-loading/09-03-SUMMARY.md
@src/cli/mod.rs
@src/cfg/reachability.rs
@src/storage/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement blast zone analysis functions</name>
  <files>src/cfg/mod.rs, src/storage/mod.rs</files>
  <action>
    Add blast zone analysis utilities:

    1. In src/cfg/mod.rs, add compute_block_impact(cfg, block_id, max_depth):
       - Use find_reachable() from reachability module to find all blocks reachable from given block
       - If max_depth specified, limit traversal depth
       - Return BlockImpact struct with:
         * source_block_id
         * reachable_blocks: Vec<BlockId>
         * reachable_count
         * max_depth_reached
         * has_cycles: bool (detects if impact contains loops)

    2. In src/storage/mod.rs, add compute_path_impact(conn, path_id):
       - Query path from cfg_paths and cfg_path_elements
       - For each block in path, compute impact
       - Aggregate results to find union of all impacted blocks
       - Query function names for each affected block (JOIN with graph_entities)
       - Return PathImpact struct with:
         * path_id
         * path_length
         * unique_blocks_affected
         * functions_affected: Vec<String>
         * total_impact_scope

    3. Add BlastZoneResponse struct for CLI output:
       ```rust
       #[derive(serde::Serialize)]
       struct BlastZoneResponse {
           kind: String,  // "block" or "path"
           source: String,
           impact_blocks: Vec<BlockId>,
           impact_functions: Vec<String>,
           depth: usize,
       }
       ```

    Use existing reachability functions (find_reachable, can_reach) from Phase 3.
  </action>
  <verify>cargo test passes, unit tests verify impact computation</verify>
  <done>Block and path impact analysis functions compute correct reachable sets</done>
</task>

<task type="auto">
  <name>Task 2: Implement blast_zone() command</name>
  <files>src/cli/mod.rs</files>
  <action>
    Replace the stub blast_zone() function (around line 1527) with full implementation:

    1. Resolve database path using resolve_db_path()
    2. Open MirageDb with error handling (follow status command pattern)
    3. Determine query type:
       - If --path-id specified: path-based impact analysis
       - Otherwise: block-based impact analysis

    4. For block-based analysis (default):
       - Resolve function from args.symbol
       - Load CFG using load_cfg_from_db()
       - Parse --block-id from args (parse block ID or default to entry block 0)
       - Call compute_block_impact(cfg, block_id, args.max_depth)
       - Query function names for impacted blocks
       - Format output

    5. For path-based analysis (--path-id):
       - Validate path_id format (BLAKE3 hex string)
       - Call compute_path_impact(db.conn(), path_id)
       - Format output

    6. Output format handling:
       - Human: print readable summary with indentation
       - Json/Pretty: return BlastZoneResponse with all impact data

    7. --include-errors flag:
       - If set, include error paths in impact analysis
       - Filter paths by path_kind = 'error' when computing union

    Error handling:
    - Function not found: helpful error suggesting 'mirage index'
    - Block ID out of range: show valid block IDs for function
    - Path not found: suggest running path enumeration first

    Response struct:
    ```rust
    #[derive(serde::Serialize)]
    struct BlockImpactResponse {
        function: String,
        block_id: usize,
        reachable_blocks: Vec<usize>,
        reachable_functions: Vec<String>,
        max_depth: usize,
        has_cycles: bool,
    }
    ```
  </action>
  <verify>cargo build succeeds, mirage blast-zone works on indexed code</verify>
  <done>mirage blast-zone command shows impact analysis for blocks and paths</done>
</task>

</tasks>

<verification>
- cargo build --release succeeds
- mirage blast-zone --function main --block-id 0 shows reachable blocks
- mirage blast-zone --path-id <id> shows functions affected by path
- JSON output format includes all impact data
- Error messages are helpful when function/path not found
</verification>

<success_criteria>
- Block-based impact analysis shows all reachable blocks/functions
- Path-based impact analysis aggregates impact across path blocks
- max_depth parameter limits impact scope
- --include-errors flag includes error paths in analysis
- JSON and human output formats supported
</success_criteria>

<output>
After completion, create `.planning/phases/09-mir-integration-database-loading/09-04-SUMMARY.md`
</output>
