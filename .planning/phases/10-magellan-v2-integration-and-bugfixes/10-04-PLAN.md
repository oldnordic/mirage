---
phase: 10-magellan-v2-integration-and-bugfixes
plan: 04
type: execute
wave: 3
depends_on: ["10-01"]
files_modified:
  - src/analysis/mod.rs
  - src/cli/mod.rs
autonomous: true

must_haves:
  truths:
    - "cycles command shows both call graph SCCs and function loops"
    - "MagellanBridge has detect_cycles() method"
    - "CLI cycles command integrates call graph and CFG cycles"
  artifacts:
    - path: "src/analysis/mod.rs"
      provides: "EnhancedCycles combining inter and intra procedural cycles"
      exports: ["EnhancedCycles", "MagellanBridge::detect_cycles"]
    - path: "src/cli/mod.rs"
      contains: "new cycles command with --include-call-graph flag"
  key_links:
    - from: "src/cli/mod.rs"
      to: "src/analysis/mod.rs"
      via: "MagellanBridge::detect_cycles()"
      pattern: "detect_cycles"
    - from: "src/cli/mod.rs"
      to: "src/cfg/loops.rs"
      via: "detect_natural_loops()"
      pattern: "detect_natural_loops"
---

<objective>
Create a cycles command that combines Magellan's call graph cycle detection (SCCs for mutual recursion) with Mirage's natural loop detection within functions.

Purpose: Complete cycle visibility - detect both function-level cycles (mutual recursion in call graph) and block-level loops (natural loops within functions).

Output: New cycles command with --include-call-graph flag showing combined cycle report.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-magellan-v2-integration-and-bugfixes/10-RESEARCH.md
@.planning/phases/10-magellan-v2-integration-and-bugfixes/10-01-SUMMARY.md

# Existing loop detection
src/cfg/loops.rs has detect_natural_loops() for intra-function loops
src/cfg/loops.rs is wired to `mirage loops` command (Phase 08-01)
</context>

<tasks>

<task type="auto">
  <name>Add cycle detection to MagellanBridge</name>
  <files>src/analysis/mod.rs</files>
  <action>
  Add to src/analysis/mod.rs:

  1. Add EnhancedCycles response struct:
     ```rust
     use std::collections::HashMap;

     #[derive(Debug, Clone, serde::Serialize)]
     pub struct EnhancedCycles {
         /// Inter-procedural: Call graph SCCs (mutual recursion)
         pub call_graph_cycles: Vec<CycleInfo>,
         /// Intra-procedural: Natural loops within functions
         pub function_loops: HashMap<String, Vec<LoopInfo>>,
         /// Total cycle count
         pub total_cycles: usize,
     }

     #[derive(Debug, Clone, serde::Serialize)]
     pub struct CycleInfo {
         pub members: Vec<String>,
         pub cycle_type: String,  // "MutualRecursion" or "SelfLoop"
         pub size: usize,
     }

     #[derive(Debug, Clone, serde::Serialize)]
     pub struct LoopInfo {
         pub header: usize,
         pub back_edge_from: usize,
         pub body_size: usize,
         pub nesting_level: usize,
     }
     ```

  2. Add cycle detection method to MagellanBridge:
     ```rust
     use magellan::{Cycle, CycleKind, CycleReport};

     impl MagellanBridge {
         /// Detect cycles in the call graph
         ///
         /// Returns strongly connected components (SCCs) with more than one member,
         /// indicating mutual recursion or self-loops.
         pub fn detect_cycles(&self) -> Result<CycleReport> {
             self.graph.detect_cycles()
         }
     }
     ```

  3. Import Cycle types from magellan::graph::algorithms
  </action>
  <verify>cargo check passes, detect_cycles compiles</verify>
  <done>MagellanBridge has detect_cycles() method</done>
</task>

<task type="auto">
  <name>Create cycles CLI command</name>
  <files>src/cli/mod.rs</files>
  <action>
  1. Add new Cycles command to Commands enum:
     ```rust
     #[derive(Subcommand, Debug, Clone)]
     pub enum Commands {
         // ... existing commands ...

         /// Show cycles in code (call graph SCCs and function loops)
         Cycles(CyclesArgs),
     }
     ```

  2. Add CyclesArgs struct:
     ```rust
     #[derive(Parser, Debug, Clone)]
     pub struct CyclesArgs {
         /// Show call graph cycles (mutual recursion between functions)
         #[arg(long)]
         pub call_graph: bool,

         /// Show function loops (within individual functions)
         #[arg(long)]
         pub function_loops: bool,

         /// Show both types of cycles (default)
         #[arg(long)]
         pub both: bool,

         /// Verbose output (show cycle members/loop bodies)
         #[arg(long)]
         pub verbose: bool,
     }
     ```

  3. Add cycles() command handler:
     - Open MagellanBridge if --call-graph or --both
     - Get call graph cycles via detect_cycles()
     - Load CFGs for functions and get natural loops if --function-loops or --both
     - Combine into EnhancedCycles response
     - Format output for human/JSON/pretty

  4. Add CyclesResponse struct:
     ```rust
     #[derive(serde::Serialize)]
     struct CyclesResponse {
         call_graph_cycles: Vec<CycleInfo>,
         function_loops: HashMap<String, Vec<LoopInfo>>,
         total_count: usize,
     }
     ```

  5. Wire up in main.rs command matcher
  </action>
  <verify>cargo check passes, cycles command compiles</verify>
  <done>cycles CLI command created and wired</done>
</task>

<task type="auto">
  <name>Test combined cycle detection</name>
  <files>src/analysis/mod.rs</files>
  <action>
  1. Add unit test for MagellanBridge::detect_cycles():
     - Create test call graph with:
       - main -> func_a -> func_b -> func_a (mutual recursion)
       - func_c -> func_c (self-loop)
     - Verify detect_cycles() returns both cycles
     - Verify cycle types are correct (MutualRecursion vs SelfLoop)

  2. Integration test for cycles command:
     - Create test database with call graph cycles
     - Create CFGs with natural loops
     - Run cycles command with --both flag
     - Verify both types of cycles are reported

  3. Add doctest examples for detect_cycles method
  </action>
  <verify>cargo test passes for cycles tests</verify>
  <done>Combined cycle detection tested</done>
</task>

</tasks>

<verification>
1. `mirage cycles --call-graph` shows call graph SCCs
2. `mirage cycles --function-loops` shows natural loops
3. `mirage cycles --both` shows combined report
4. Cycle types (MutualRecursion, SelfLoop) correctly identified
5. All tests pass
</verification>

<success_criteria>
1. New cycles command works
2. Detects both inter-procedural (SCC) and intra-procedural (natural loop) cycles
3. Output clearly separates the two types
4. Verbose mode shows cycle member details
5. Wires correctly in main.rs
</success_criteria>

<output>
After completion, create `.planning/phases/10-magellan-v2-integration-and-bugfixes/10-04-SUMMARY.md`
</output>
