---
phase: 06-cli-interface
plan: 07
type: execute
wave: 4
depends_on: [06-01, 06-02, 06-03, 06-04, 06-05, 06-06]
files_modified: [src/cli/mod.rs]
autonomous: true

must_haves:
  truths:
    - "All commands support --output json|pretty|human"
    - "Output format handling is consistent across all commands"
    - "JSON responses use JsonResponse wrapper"
  artifacts:
    - path: "src/cli/mod.rs"
      provides: "Standardized output format handling across all commands"
      min_lines: 10
  key_links:
    - from: "all command handlers"
      to: "src/output/mod.rs::JsonResponse"
      via: "standardized wrapper pattern"
      pattern: "JsonResponse::new"
---

<objective>
Ensure all CLI commands support the three output formats (human/json/pretty) consistently and use the JsonResponse wrapper for JSON outputs. This plan standardizes the output handling across all commands.

**Purpose:** Provide consistent user experience across all commands with predictable output formatting.

**Output:** All commands following the same output format pattern.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-interface/06-RESEARCH.md
@src/cli/mod.rs
@src/output/mod.rs
@.planning/phases/06-cli-interface/06-01-PLAN.md
@.planning/phases/06-cli-interface/06-02-PLAN.md
@.planning/phases/06-cli-interface/06-03-PLAN.md
@.planning/phases/06-cli-interface/06-04-PLAN.md
@.planning/phases/06-cli-interface/06-05-PLAN.md
@.planning/phases/06-cli-interface/06-06-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Verify and standardize output format handling across all commands</name>
  <files>src/cli/mod.rs</files>
  <action>
  Review all command handlers in src/cli/mod.rs and verify consistent output handling:

  1. Check each command handler has correct signature to access cli.output:
     - paths(args, cli)
     - cfg(args, cli)
     - dominators(args, cli)
     - unreachable(args, cli)
     - verify(args, cli)
     - status(args, cli) - already verified in 06-06

  2. Verify each command handles all three output formats:
     - Match on cli.output { Human, Json, Pretty }
     - Human: Print human-readable text with println!
     - Json: Use JsonResponse::new(data).to_json()
     - Pretty: Use JsonResponse::new(data).to_pretty_json()

  3. Verify JsonResponse wrapper usage:
     - All JSON modes wrap data in JsonResponse
     - Response structs derive serde::Serialize
     - Consistent field naming (snake_case for JSON)

  4. Fix any inconsistencies found:
     - Add missing format branches
     - Wrap bare JSON in JsonResponse
     - Ensure error messages use output::error() helper

  5. Add a helper function if useful for reducing duplication:
     - Consider `print_json<T>(cli: &Cli, data: T)` if pattern is repeated
  </action>
  <verify>
  Run `cargo build` to verify compilation.
  </verify>
  <done>
  All commands have consistent output format handling:
  - Every command respects --output flag
  - JSON outputs use JsonResponse wrapper
  - Human outputs are readable and informative
  - Error handling is consistent
  </done>
</task>

<task type="auto">
  <name>Add integration test for all commands with each output format</name>
  <files>src/cli/mod.rs</files>
  <action>
  In the `#[cfg(test)] mod tests` section, add:

  1. Test that verifies each command can be instantiated with different output formats
  2. Test that JsonResponse wrapping produces valid JSON
  3. Test that human format output doesn't contain JSON characters
  4. Test error handling consistency

  Since we can't run the full CLI in integration tests easily, focus on:
  - Verifying response structs serialize correctly
  - Verifying JsonResponse wrapper works for all response types
  - Verifying format selection logic
  </action>
  <verify>
  Run `cargo test` to verify all tests pass.
  </verify>
  <done>
  Tests verify output format consistency across all commands.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- [ ] `cargo build` succeeds with no warnings
- [ ] `cargo test` passes all tests
- [ ] All commands support --output human
- [ ] All commands support --output json
- [ ] All commands support --output pretty
- [ ] JsonResponse wrapper used consistently
- [ ] Error messages use output::error() helper
- [ ] Exit codes are consistent (using output::EXIT_* constants)
</verification>

<success_criteria>
1. `mirage paths --function X --output json` outputs JsonResponse-wrapped JSON
2. `mirage cfg --function X --output json` outputs JsonResponse-wrapped JSON
3. `mirage dominators --function X --output json` outputs JsonResponse-wrapped JSON
4. `mirage unreachable --function X --output json` outputs JsonResponse-wrapped JSON
5. `mirage verify --path-id X --output json` outputs JsonResponse-wrapped JSON
6. `mirage status --output json` outputs JsonResponse-wrapped JSON
7. All commands work with --output pretty and --output human
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-interface/06-07-SUMMARY.md`
</output>
