---
phase: 01-database-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/storage/mod.rs
  - tests/database_integration.rs
autonomous: true

must_haves:
  truths:
    - "Database can be created from scratch in a real Magellan database"
    - "Foreign key constraints prevent invalid data insertion"
    - "Function hash tracking enables incremental updates"
    - "Migration framework correctly handles schema upgrades"
  artifacts:
    - path: "tests/database_integration.rs"
      provides: "Integration tests for database layer"
      contains: "test_.*_integration"
  key_links:
    - from: "Integration tests"
      to: "Real Magellan database"
      via: "Test database setup and teardown"
      pattern: "Connection::open"
---

<objective>
Create comprehensive integration tests for database layer

Purpose: Verify the database schema works correctly with real Magellan databases
and all Phase 1 requirements are satisfied.

Output: Test suite that validates schema creation, foreign keys, and incremental updates.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@src/storage/mod.rs
@.planning/phases/01-database-foundation/01-01-SUMMARY.md
@.planning/phases/01-database-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test file with Magellan database setup</name>
  <files>tests/database_integration.rs</files>
  <action>
    Create a new integration test file `tests/database_integration.rs`:

    1. Add a helper function to create a minimal Magellan database:
       ```rust
       fn create_test_magellan_db() -> tempfile::NamedTempFile {
           let db = tempfile::NamedTempFile::new().unwrap();
           let conn = Connection::open(db.path()).unwrap();
           // Create magellan_meta, graph_entities, ast_nodes tables
           // Insert minimal data for foreign key tests
           db
       }
       ```

    2. This provides a real Magellan database environment for testing Mirage's
       schema extensions.

    3. Include necessary imports: rusqlite, tempfile, crate::storage.
  </action>
  <verify>Run `cargo test --test database_integration` to verify test file is found</verify>
  <done>Integration test file exists with Magellan database setup helper</done>
</task>

<task type="auto">
  <name>Task 2: Add test for schema creation in real Magellan database</name>
  <files>tests/database_integration.rs</files>
  <action>
    Add test `test_schema_creation_in_magellan_db`:

    1. Create a Magellan database with schema version 4
    2. Call `create_schema()` to add Mirage tables
    3. Verify all Mirage tables exist:
       - cfg_blocks
       - cfg_edges
       - cfg_paths
       - cfg_path_elements
       - cfg_dominators
       - cfg_post_dominators
       - mirage_meta

    4. Verify indexes were created by querying sqlite_master:
       ```sql
       SELECT name FROM sqlite_master
       WHERE type='index' AND tbl_name LIKE 'cfg_%'
       ```

    5. Verify mirage_meta has correct schema versions

    This validates DB-01, DB-02, DB-03, DB-04 requirements.
  </action>
  <verify>Run `cargo test --test database_integration test_schema_creation_in_magellan_db`</verify>
  <done>All Mirage tables and indexes are created in real Magellan database</done>
</task>

<task type="auto">
  <name>Task 3: Add test for foreign key constraint enforcement</name>
  <files>tests/database_integration.rs</files>
  <action>
    Add test `test_foreign_key_enforcement`:

    1. Create Magellan database with graph_entities entry
    2. Insert valid cfg_blocks referencing that function_id -> should succeed
    3. Attempt to insert cfg_blocks with non-existent function_id -> should fail
    4. Insert cfg_edges referencing valid block IDs -> should succeed
    5. Attempt to insert cfg_edges with invalid block IDs -> should fail

    6. Verify foreign keys are enabled:
       ```sql
       PRAGMA foreign_keys;
       ```

    This validates DB-05 requirement.
  </action>
  <verify>Run `cargo test --test database_integration test_foreign_key_enforcement`</verify>
  <done>Foreign key constraints prevent invalid relationships</done>
</task>

<task type="auto">
  <name>Task 4: Add test for incremental update tracking</name>
  <files>tests/database_integration.rs</files>
  <action>
    Add test `test_incremental_update_tracking`:

    1. Insert cfg_blocks with function_hash = "abc123"
    2. Query for blocks with that hash
    3. Update function_hash to "def456" (simulating code change)
    4. Verify query by old hash returns empty, new hash returns results

    5. Add a helper function that demonstrates the incremental workflow:
       ```rust
       fn needs_reanalysis(conn: &Connection, function_id: i64, new_hash: &str) -> Result<bool> {
           // Query existing function_hash for this function
           // Return true if hash differs or function not found
       }
       ```

    This validates DB-06 requirement.
  </action>
  <verify>Run `cargo test --test database_integration test_incremental_update_tracking`</verify>
  <done>Function hash tracking enables incremental update detection</done>
</task>

<task type="auto">
  <name>Task 5: Add test for migration framework</name>
  <files>tests/database_integration.rs</files>
  <action>
    Add test `test_migration_framework`:

    1. Create database at schema version 0 (no mirage_meta)
    2. Run `migrate_schema()` -> should create mirage_meta with version 1
    3. Run `migrate_schema()` again -> should detect version 1, do nothing

    4. Test error case: database with schema version 2 (newer than supported)
    5. Verify MirageDb::open() returns appropriate error

    This verifies the migration framework for future schema changes.
  </action>
  <verify>Run `cargo test --test database_integration test_migration_framework`</verify>
  <done>Migration framework handles version upgrades and error cases</done>
</task>

</tasks>

<verification>
Overall phase verification:
1. Run all integration tests: `cargo test --test database_integration`
2. All tests pass
3. Code coverage shows storage module is well-tested
4. Tests verify all DB-01 through DB-06 requirements

Run tests with output:
```bash
cargo test --test database_integration -- --nocapture
```
</verification>

<success_criteria>
1. Schema creation test validates all tables exist in Magellan database
2. Foreign key test prevents invalid data insertion
3. Incremental update test demonstrates hash-based change detection
4. Migration test covers version 0->1 upgrade and newer schema error handling
5. All Phase 1 database requirements (DB-01 through DB-06) are verified
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-03-SUMMARY.md` with:
- Test suite summary
- Coverage achieved
- Any edge cases discovered
- Confirmation all Phase 1 requirements met
</output>
